




<!--
 /\* Font Definitions \*/
 @font-face
 {font-family:Courier;
 panose-1:2 7 4 9 2 2 5 2 4 4;}
@font-face
 {font-family:Helv;
 panose-1:2 11 6 4 2 2 2 3 2 4;}
@font-face
 {font-family:"Cambria Math";
 panose-1:2 4 5 3 5 4 6 3 2 4;}
 /\* Style Definitions \*/
 p.MsoNormal, li.MsoNormal, div.MsoNormal
 {margin-top:0cm;
 margin-right:0cm;
 margin-bottom:8.0pt;
 margin-left:0cm;
 line-height:107%;
 font-size:11.0pt;
 font-family:"Calibri",sans-serif;}
.MsoChpDefault
 {font-size:11.0pt;}
.MsoPapDefault
 {margin-bottom:8.0pt;
 line-height:107%;}
 /\* Page Definitions \*/
 @page WordSection1
 {size:612.0pt 792.0pt;
 margin:72.0pt 72.0pt 72.0pt 72.0pt;}
div.WordSection1
 {page:WordSection1;}
-->




**Initial Release 6.0.2**



**Symbolic Value : Smartcards**



**SC\_manip\_xxx** **-** Opcodes
defined for SECManipulateSC


**----------------------------------------------------------------------------------------------------------**



**#include <kfm.h>**


 **Symbolic Values :**      SC\_manip\_GetVersion          -  Get the version of the
specification.  

  

      SC\_manip\_InitializeContext   -  Initialize a Smartcard context.  

  

      SC\_manip\_TerminateContext            -  Terminates the Smartcard code.  

  

      SC\_manip\_CheckCard          -  Check the current Smartcard  

  

      SC\_manip\_EnterIDFile          -  Opens the indicated ID.  

  

      SC\_manip\_EnterPIN             -  Logs the user into the smartcard.  

  

      SC\_manip\_SCEnableID         -  Smartcard-enable the "entered"
ID file with the current smartcard.  

  

      SC\_manip\_PushInetKey        -  Pushes the private key associated with the
current signing internet certificate onto the Smartcard.  

  

      SC\_manip\_FindMatchedCerts           -  Initializes a search for
importable certificates and private keys on a Smartcard.  

  

      SC\_manip\_GetMatchedCert   -  Examines the certificates that are available
for import from the smartcard into the ID file. See SC\_MANIP\_IMPORTABLE\_CERT.  

  

      SC\_manip\_ImportInetCert     -  Reads the indicated certificate from the
Smartcard.  

  

      SC\_manip\_RefreshTokenInfo            -  Refreshes the token
identification information that is stored in the ID file.  

  

      SC\_manip\_PushKyrKey        -  Pushes the private key from an SSL keyring
file onto a smartcard or a PKCS#11-based cryptographic accelerator.  

  

      SC\_manip\_PushNotesKey     -  Pushes a "large" (1024 or
2048-bit) Notes key onto a smartcard.  

  

      SC\_manip\_EnterIDPassword             -  Unlock the non-smartcard-enabled
ID file entered through EnterIDFile with the supplied password  

  

      SC\_manip\_FindAllKeys         -  Acquire all keys from all smartcards and
return the number of keys available to the caller.  

  

      SC\_manip\_LockIDWithKeyRO           -  Smartcard-enable the ID file by
encrypting it with a password-equivalent generated by signing a random seed
value. This opcode will work with most read-only ID files.  

  

      SC\_manip\_LockIDWithKeyRnd          -  Smartcard-enable the ID file by
encrypting it with a symmetric key that is wrapped by a key on the token.  

  

      SC\_manip\_PushInetKeyAndCert        -  Identical to the
SC\_manip\_PushInetKey, except that it also push the corresponding X.509
certificate onto the smartcard or other cryptographic token.  

  

      SC\_manip\_PushKyrKeyAndCert        -  Identical to the
SC\_manip\_PushKyrKey, except that it also push the corresponding X.509
certificate onto the smartcard or other cryptographic token.  

  




**Description :**



SC\_manip\_GetVersion:       
Get the version of the specification.  

  

                                  Input Parameters:  

                                        pContext     - Unused  

                                        pdwFlags     - Unused  

                                        pdwParam1    - points to a DWORD  

                                        pvParam2     - Unused  

  

                                  Output Parameters:  

                                        \*pdwParam1   - Filled with the version
of the specification. 0 for 6.0.2


  

                             SC\_manip\_GetVersion is the only opcode that can be
called without a valid SCMCTX.  

  




SC\_manip\_InitializeContext: 
Initialize a Smartcard context.  

  

                                  Input Parameters:  

                                        pContext     - Address of a NULLSCMCTX.
See NULLSCMCTX  

                                        pdwFlags     - Unused  

                                        pdwParam1    - Unused  

                                        pvParam2     - Unused  

  

                                  Output Parameters:  

                                        \*pContext    - Filled with the
initialized SCMCTX


  

                             SC\_manip\_InitializeContext allocates a SCMCTX and
initializes the PKCS #11 code. 


                            
Returns ERR\_BSAFE\_SC\_INVALID\_CONFIG if the local smartcard config is incorrect;



                            
Returns ERR\_BSAFE\_INSERT\_SMARTCARD if a token is not in the slot.


                            
If multiple slots are provided by the PKCS #11 DLL, this uses the first one.


 


SC\_manip\_TerminateContext:  
Terminates the Smartcard code.  

  

                                  Input Parameters:  

                                        pContext     - Valid context.  

                                        pdwFlags     - Unused  

                                        pdwParam1    - Unused  

                                        pvParam2     - Unused  

  

                                  Output Parameters:  

                                        \*pContext    - Zeroed.  

  

                             Terminates the Smartcard code, cleans up the ID
file if any, frees the SCMCTX, and zeroes   

                             \*pContext.


 


SC\_manip\_CheckCard:         
Check the current Smartcard.  

  

                                  Input Parameters:  

                                        pContext      - Valid context  

                                        pdwFlags      - Unused  

                                        pdwParam1     - Unused  

                                        pvParam2      - Unused  

  




                                 
Output Parameters:  

                                        None  

  

                             CheckCard determines if the current smartcard can
support Notes properly, and will return  

                             error codes for any potential problems that it can
detect. This does not check for free space   

                             on the card.


 


                                 
ERR\_BSAFE\_SC\_INVALID\_CONFIG   - Notes is not configured to use a smartcard
reader. 


                                                                 
Does the PKCS11\_Library notes.ini variable contains the  

                                                                  path to your
PKCS#11 DLL? 


                                 
ERR\_BSAFE\_INSERT\_SMARTCARD    - No card is present in the reader


                                 
ERR\_BSAFE\_SC\_UNSUPPORTED\_FUNC - The card doesn't support multiple concurrent
sessions


                                 
ERR\_BSAFE\_SC\_KEY\_CREATE       - The card doesn't provide the cryptographic
capabilities   

                                                                  required by
Notes. 


 


SC\_manip\_EnterIDFile:      
Opens the indicated ID file.  

  

                                  Input Parameters:  

                                        pContext       - Valid context  

                                        pdwFlags       - Unused  

                                        \*pdwParam1     - Length of the string
in pvParam2


                                        pvParam2      
- BYTE\*; null-terminated string holding path to the ID file to be   

                                                         opened  

  

                                  Output Parameters:  

                                        None


  

                             Opens the indicated ID file and stores the hKFC in
the SCMCTX. Will prompt for the ID file if  

                             none is provided and the caller  has a valid
prompt set -- there is no console prompt for an  

                             ID file. If the ID is smartcard-enabled and
SC\_manip\_EnterPIN was previously called, the ID   

                             file will be unlocked and opened for write.   This
OpCode may be called repeatedly on a   

                             single context, effective switching the ID file
being used. SC\_manip\_InitializeContext   

                             allocates a SCMCTX and initializes the PKCS #11
code. 


 


SC\_manip\_EnterPIN:          
Logs the user into the Smartcard.  

  

                                  Input Parameters:  

                                        pContext       - Valid context  

                                        pdwFlags       - Unused  

                                        \*pdwParam1     - PIN length


                                       
pvParam2       - BYTE\*; null-terminated string containing the PIN for the
current   

                                                         Smartcard  

  

                                  Output Parameters:  

                                        None  

  




                            
If the token has a protected authentication path, this will trigger the
protected authentication  

                             path. Otherwise, an explicit PIN will be passed to
C\_Login and a NULL or zero-length PIN will cause    

                             Notes to prompt for the PIN.  If
SC\_manip\_EnterIDFile was previously called and that ID file is   

                             smartcard-enabled, this OpCode will unlock the ID
file and re-open the hKFC for write.


 


SC\_manip\_SCEnableID:        
Smartcard-enable the "entered" ID file with the current Smartcard.  

  

                                 Input Parameters:  

                                       pContext       - Valid context  

                                       pdwFlags       - Unused  

                                       \*pdwParam1     - Password length


                                      
pvParam2       - BYTE\*; null-terminated password for the ID file  

  

                                 Output Parameters:  

                                       None  

  

                             Obviously, must be called after
SC\_manip\_EnterIDFile and SC\_manip\_EnterPIN. If a NULL or zero-length   

                             password is passed in, Notes will prompt for the
ID file's password. 


                            
Returns ERR\_BSAFE\_CERT\_ALREADY\_IN\_ID\_FILE if the ID file is already
smartcard-enabled. 


 


SC\_manip\_PushInetKey:       
Pushes the private key associated with the current signing internet certificate
onto the Smartcard.   

  

                                 Input Parameters:  

                                       pContext       - Valid context  

                                       pdwFlags       - Unused  

                                       pdwParam1      - Unused


                                      
pvParam2       - Unused  

  




                               
 Output Parameters:  

                                       None  

  

                             Future versions of this opcode will allow the
administrator to specify which certificate they want  

                             to push onto the Smartcard. 


 


SC\_manip\_FindMatchedCerts:  
Initializes a search for importable certificates and private keys on a
Smartcard.    

  

                                 Input Parameters:  

                                       pContext       - Valid context  

                                       pdwFlags       - Unused  

                                       pdwParam1      - Must point to a DWORD


                                      
pvParam2       - Unused  

  

                                 Output Parameters:  

                                       \*pdwParam1     - Number of matching
certs found  

  

                             The number of importable certs found is returned
in \*pdwParam1. This function does not require an ID  

                             file (nor a PIN login, although many cards will
not yield up useful or complete information without   

                             one), as it can be used for informational purposes
only.  The range of valid ordinals for   

                             SC\_manip\_GetMatchedCert and SC\_manip\_InetCert is
from 0 to \*pdwParam1-1 , inclusive. This OpCode can   

                             take a considerable amount of time to complete, as
it performs a number of searches on a medium that   

                             is traditionally extremely slow.


 


SC\_manip\_GetMatchedCert:    
Examines the certificates that are available for import from the Smartcard into
the ID file.  

  

                                 Input Parameters:  

                                       pContext       - Valid context  

                                       pdwFlags       - Unused  

                                       \*pdwParam1     - The ordinal of the pair
to be returned. [0...N-1]


                                      
pvParam2       - Optional; points to allocated SC\_MANIP\_IMPORTABLE\_CERT  

  

                                 Output Parameters:  

                                       \*pdwParam1     - Returns the size
used/needed by the SC\_MANIP\_IMPORTABLE\_CERT  

                                       \*pvParam2      - If non-NULL and sufficiently
large, filled in SC\_MANIP\_IMPORTABLE\_CERT  

  




                            
This must be called after SC\_manip\_FindMatchedCerts, as it relies on the
information that was stored   

                             in the SCMCTX.


 


SC\_manip\_ImportInetCert:
    Reads the indicated certificate from the Smartcard.  

  

                                 Input Parameters:  

                                       pContext       - Valid context  

                                       pdwFlags       - Unused  

                                       \*pdwParam1     - The ordinal of the pair
to be imported


                                      
pvParam2       - Unused  

  

                                 Output Parameters:  

                                       None  

  

                             Reads the indicated certificate from the
Smartcard, and stores the certificate, public key, and a   

                             reference to the private key in the Notes ID file.
If the certificate can be used for signing, then 


            
                it will become the default S/MIME signing certificate. Must be
called after SC\_manip\_EnterIDFile, 


                            
SC\_manip\_EnterPIN, and SC\_manip\_FindMatchingCerts.


 


 


SC\_manip\_RefreshTokenInfo   
Refreshes the token identification information that is stored in the ID file.


 


                                
Input Parameters:  

                                       pContext       - Valid context  

                                       pdwFlags       - Unused  

                                       \*pdwParam1     - Unused 


                                      
pvParam2       - Unused  

  

                                 Output Parameters:  

                                       None


 


                            
Must be called after SC\_manip\_EnterIDFile and SC\_manip\_EnterPIN.


 


SC\_manip\_PushKyrKey         
Pushes the private key from an SSL keyring file onto a smartcard or a
PKCS#11-based cryptographic  

                             accelerator.


                                



                                
Input Parameters:


                                      
pContext       - Must have been be initialized


                                      
pdwFlags       - NULL


               
                       pdwParam1      - NULL


                                      
pvParam2       - Path to keyring file  

  

                                 Output Parameters:  

                                       None


 


                            
Pushes the private key from an SSL keyring file onto a smartcard or, more
likely, a PKCS#11-based 


                            
cryptographic accelerator.  SC\_manip\_PushKyrKey can only be called if the
server's ID file has 


                            
already been smartcard-enabled, potentially via SC\_manip\_SCEnableID, and it
must be called after   

                             InitializeContext, SC\_manip\_EnterIDFile, and
SC\_manip\_EnterPIN. 


 


SC\_manip\_PushNotesKey       
Pushes a "large" (1024 or 2048-bit) Notes key onto a smartcard. 


                                 



                                
Input Parameters:


                                      
pContext       - Must have been be initialized


                                      
pdwFlags       - NULL


                                      
pdwParam1      - NULL


                                      
pvParam2       - NULL  

  

                                 Output Parameters:  

                                       None


 


                            
Writes the (BER-encoded) Notes domestic private key to a  smartcard, make the
key recoverable,   

                             and replaces the key in the ActiveUDO with a
pointer to the key on the card.  


                            
SC\_manip\_PushNotesKey can only be called if the ID file has already been
smartcard-enabled, 


                            
potentially via SC\_manip\_SCEnableID, and it must be called after
InitializeContext,    


                            
SC\_manip\_EnterIDFile, and SC\_manip\_EnterPIN.


 


   
SC\_manip\_EnterIDPassword    Unlock the non-smartcard-enabled ID file entered
through EnterIDFile with the supplied password. 


                               
If \*pdwParam1 and pvParam2 are not passed in, the user will be prompted for the
password, if    

                                possible.


 


                                
Input Parameters:


              
                        pContext       - Must have been be initialized


                                      
pdwFlags       - NULL


                                      
pdwParam1      - Length of ID file password, if any


                                
      pvParam2       - Points to ID file password, if any  

  

                                 Output Parameters:  

                                       None


 


                             
  SC\_manip\_EnterIDPassword
is used before the SC\_manip\_LockIDWithKeyRO opcode in order to unlock the   

                                ID file that is about to be smartcard-enabled,
if the ID file was previously not smartcard-enabled.


 


   SC\_manip\_FindAllKeys        
Acquire all keys from all smartcards and return the number of keys available to
the caller.


 


                                
Input Parameters:


                                      
pContext       - Must have been be initialized


              
                        pdwFlags       - NULL


                                      
pdwParam1      - Must point to a DWORD


                                      
pvParam2       - NULL  

  

                                 Output Parameters:  

                                        pdwParam1      - Filled in with number
of certs available


 


                               
SC\_manip\_FindAllKeys can be used with SC\_manip\_GetMatchedCert in the same
fashion as   

                                SC\_manip\_FindMatchedCerts to find private RSA
keys without matching certificates.  These keys cannot  

                                be imported into the ID file, due to the lack
of matching certificates, but they can be used with   

                                SC\_manip\_LockIDWithKeyRO and
SC\_manip\_LockIDWithKeyRnd to secure the ID file. 


 


   SC\_manip\_LockIDWithKeyRO    
Smartcard-enable the ID file by encrypting it with a password-equivalent
generated by signing a   

                                random seed value. This opcode will work with
most read-only ID files. 


                               
This is a valid upgrade path for regular smartcard-enabled ID files.
SC\_manip\_EnterIDPassword must   

                                be used before calling this function with
non-smartcard-enabled ID files.


 


                                
Input Parameters:


                                      
pContext       - Must have been be initialized


                                      
pdwFlags       - Currently unused


                      
                pdwParam1      - Ordinal of the key to use


                                      
pvParam2       - Currently unused  

  

                                 Output Parameters:  

                                       None


 


                               
This is currently the recommended technique for protecting an ID file with a
smartcard. This opcode   

                                uses the same mechanism as the  "Lock ID
with Key on Smartcard" menu option that is accessible from   

                                the "Other Actions" button on the
"Your Certificates" pane of the User Security Dialog when a   

                                certificate corresponding to a private key on a
smartcard has been selected.   An ID file protected   

                                in this fashion cannot be used with a Notes
client or Domino server before ND7, but can be recovered   

                                through the ID File Recovery process. 


 


  
SC\_manip\_LockIDWithKeyRnd    Smartcard-enable the ID file by encrypting it with
a symmetric key that is wrapped by a key on the   

                                token. This is a valid upgrade path for regular
smartcard-enabled ID files. SC\_manip\_EnterIDPassword   

                                must be used before calling this function with
non-smartcard-enabled ID files.


 


                                
Input Parameters:


                                      
pContext       - Must have been be initialized


                                      
pdwFlags       - Currently unused


                                      
pdwParam1      - Ordinal of the key to use


                                      
pvParam2       - Currently unused  

  

                                 Output Parameters:  

                                       None


 


                               
This technique will only work with a small set of smartcards with substantially
above-average   

                                cryptographic support, including performing
symmetric encryption in hardware; in most cases,    

                                SC\_manip\_LockIDWithKeyRO should be used
instead. As ID File Recovery will not be able to recover an   

                                ID file protected with this technique, this
function has been effectively deprecated in favor of   

                                SC\_manip\_LockIDWithKeyRO. 


 **See Also :**


**[SC\_MANIP\_IMPORTABLE\_CERT](notes:///8525872100478C66/61FD4E9848264AD28525620B006BA8BD/A957E6868DF2835085256CFC006EE297)**


**[SECManipulateSC](SECManipulateSC.md)**



----------------------------------------------------------------------------------------------------------


 





